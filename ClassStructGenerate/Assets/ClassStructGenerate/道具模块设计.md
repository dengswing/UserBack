# 道具模块设计 module_item
========================

维护人 | 版本号 | 描述 | 日期
--- | --- | --- | ---
Jonathan Dai | 0.1 | 初版 | 2013-12-11
Jonathan Dai | 0.2 | 重新设计背包空间购买定价配置 | 2013-12-20
Jonathan Dai | 0.3 | 将名字和资源字段重新放回道具定义表 | 2013-12-24
Jonathan Dai | 0.4 | 调整购买道具接口参数 | 2013-12-24
Jonathan Dai | 0.5 | 添加配置文件位置描述 | 2014-01-02
Jonathan Dai | 0.6 | 添加获取道具定价信息接口 | 2014-01-10
fengjie | 0.7 | 更新道具配置表资源id的类型，由int改为string类型，策划将会提供资源的路径 | 2014-02-10
fengjie | 0.8 | 删除商城配置表中商品的名称与资源 | 2014-02-17
fengjie | 0.9 | 增加道具礼包配置表与相关逻辑 | 2014-02-24
fengjie | 1.0 | 更新API4.4 接口参数 | 2014-02-24
jinling | 1.1 | 更新API4.4 接口参数,添加跳过检查的项目 | 2014-08-18

---

## 1. 设计
### 1.1 概念
用来存储用户道具数据（背包）并进行交互的模块。
主要功能有道具购买、出售的逻辑处理，以及增加、减少玩家道具数量的逻辑处理。 
这里有一点需要明确的是，在该模块中进行的所有逻辑处理，不包含配置读取和数据库存取的逻辑。
所有上述逻辑全部在模块之外操作完成，而模块内则只包含道具相关的逻辑处理。

### 1.2 设计
数据结构分为道具表和背包容量表，前者存储玩家背包内容，后者存储玩家背包容量值。

依赖：

* 依赖支付模块，扩容背包容量是使用支付的

虚拟货币id的设计：

* 游戏系统使用的货币系统应该是一个虚拟的货币系统，所有的货币种类在道具系统中需要有虚拟货币id定义
* 如果和任务系统一起使用的话，则可以使用任务系统中的entity概念，将货币都配置在entityId里，这里的priceId、recycleId和entityId一致就可以了
* 如果单独使用的话，就需要定义应该在APP的const常量字典表里，并在整个APP流程中全部使用虚拟的货币id进行支付、扣费流程
* 这些虚拟货币并不会实际存储在玩家的道具数据库中，而是以一种虚拟的形式被配置在配置表里，方便使用而已

每日限购的设计：

* 每日限购这里的每日指0点到0点的一个自然日
* 玩家的每日限购功能需要在APP级别维护一个玩家的当日购买列表
* 这个购买列表并不会被存储在数据库中，而是以玩家的id为键值存储在cache中
* 因为关系到真正的业务逻辑（非致命业务逻辑），这个数据尽量不要存储在内存容易被消耗完（数据容易被顶掉）的app cache中，而是尽量存储在static cache中

背包设计：

* 默认使用真实货币兑换的代币进行购买格子容量
* 背包容量分为：
	* 系统默认设定容量（玩家初始就拥有的容量）
	* 玩家购买的容量
	* 两者相加才是背包真正的总容量
* 在app程序中处理背包逻辑时，需要特别注意一点，在使用礼包，或者可兑换的道具时，需要先处理减物品的逻辑，然后再处理加物品的逻辑，因为在礼包或可兑换的道具使用掉的时候，会造成背包空间的释放，这个时候如果兑换、合成出来的道具只占一格的话，程序应该正常完成
* 背包在遇到满格的情况，会分为两种行为：
	* 允许溢出。在addItem函数调用时，传入的$allowExceed传入TRUE，那么在遇到溢出时，系统不会抛错，但同时也不会向背包内添加内容，直接安静跳出
	* 不允许溢出。在addItem函数调用时，传入的$allowExceed传入FALSE，或不传参（启用默认参数），那么在遇到溢出时，系统会抛错，并终止当前逻辑

## 2. 配置
该模块的配置文件应该放置在app的语言文件夹下：
APP_ROOT/config/**en_us**/module_item/*.config.php

### 2.1 道具配置表
配置文件名：module_item_def
配置表结构：

字段名	 | 类型 | 默认值 | 使用者 | 索引 | 描述 
--- | --- | --- | --- | --- | ---
itemDefId | int | - | both | pri | 道具定义id
name | string | - | client | - | 道具名称
resourceId | string | - | client | - | 道具的资源id：icon、动画，etc…
type | int | - | both | - | 道具类型
quality | int | - | both | - | 道具品质：橙、紫，etc…
stackCount | int | - | both | - | 道具每个格子的堆叠数量
binding | int | - | both | - | 道具的可互动性：是否可出售，etc…
ownLimit | int | - | both | - | 拥有上限：玩家拥有该道具的总上限
duration | int | - | both | - | 有效期：单位为秒，大于0时表示该道具为时效性道具
recycleId | int | - | both | - | 出售该道具时获得的虚拟货币的id
recycleCount | int | - | both | - | 出售该道具时获得的虚拟货币的数量
actionId | int | - | server | - | 该道具的行为id：e.g，1表示打开礼盒，etc…
description | string | - | client | - | 道具描述

说明：

* stackCount：
	* 如果该值为1，表示该物品无法堆叠（装备）
	* 如果该值大于1，表示该物品在一个背包格子内可被堆叠到指定数量的个数，达到上限之后，则会占用一个新的背包格子
	* 如果道具的duration配置非0，表示该道具为时效性道具
		* 如果堆叠配置为1，则每次添加该物品都会添加一个新的物品（占一新背包格子）而不会延续以前那个物品的时长
		* 如果堆叠配置大于1，则每次添加该物品都会延续以前那个物品的时长，而不会添加一个新的道具
	* 如果不需要堆叠上限的话，只需要配置得和ownLimit一致，就可以了
* binding：道具的可互动性，所有的选项都必须是2的n次方，最高到128，也就是有8个选项
	* 1、2、4、8：暂定为回收性设置，拥有这些属性表示玩家可以执行物品出售操作（给系统或玩家等），具体的细节由使用方系统决定，一旦物品拥有该系列属性中的任意一项，则recycleItem接口可以顺利通过
	* 16 - 128：暂空
	* 如果同时具有多个选项特性，则只要将其相加即可，e.g
		* 即能被系统回收，又可以当礼物：1 + 2 = 3
		* 即能被系统回收，又可被交易：1 + 4 = 5
	* 使用的时候进行与操作，结果大于0则表示该选项存在
* actionId：具体的关联行为需要在游戏逻辑中自行实现，这里只是提供一个id保存位置

### 2.2	道具商城配置表
配置文件名：module_item_store

配置表结构：ItemSore

字段名	 | 类型 | 默认值 | 使用者 | 索引 | 描述 
--- | --- | --- | --- | --- | ---
itemDefId | int | - | both | pri | 道具定义id
weight | int | - | client | - | 道具在商城中展示的权重值
onShelf | timestamp | - | both | - | 道具上架时间
offShelf | timestamp | - | both | - | 道具下架时间
price | json | - | both | - | 道具价格：{"priceId": priceCount, …}，购买该道具时需要用来支付的虚拟货币id和数量
count | int | - | both | - | 道具购买的个数，购买一次，添加几个当前道具
discount | float | - | both | - | 道具售卖的折扣：e.g 0.5 表示5折
discountStart | timestamp | - | both | - | 打折开始时间
discountEnd | timestamp | - | both | - | 打折结束时间
level | int | - | both | - | 购买的限制等级
friend | int | - | both | - | 购买需要的平台好友个数
dailyPurchaseLimit | int | - | both | - | 每日购买上限


### 2.3 道具模块杂项配置
配置文件名：module_item
配置表结构：

字段名	 | 类型 | 默认值 | 使用者 | 索引 | 描述 
--- | --- | --- | --- | --- | ---
key | string | - | both | pri | 杂项配置的键值
value | string | - | both | - | 杂项配置的值

配置表必须项：

字段名	 | 类型 | 默认值 | 描述 
--- | --- | --- | --- 
maxPackageCount | int | - | 这个配置项决定了背包空间的大小，如果这个项配成了0的话，系统会认为背包大小是不限的

这些是该模块的杂项配置中必须有的项目

### 2.4 道具背包容量购买配置
配置文件名：module_item_package
配置表结构：

字段名	 | 类型 | 默认值 | 使用者 | 索引 | 描述 
--- | --- | --- | --- | --- | ---
gridId | int | - | both | pri | 扩展的背包格子id，从1开始
price | json | - | both | - | 价格：{"priceId": count, ...}

## 3. 存储结构
### 3.1 购买记录（非db物理表，详细见上文）
结构：

	$itemPurchaseRecords = array (
		'timestamp' => 最后一次购买任意限量道具的时间点的UNIX时间戳,
		'records' => array(
			'itemDefId' => 'count',
			...
		),
	);

### 3.2 玩家道具数据表
表名：module_item

字段名	 | 类型 | 默认值 | 索引 | 备注 
--- | --- | --- | --- | ---
itemId | int | - | pri | 道具存储id（自增长字段）。道具在数据库中的唯一id，对任何道具的操作都将以此id为准
userId | int | - | - | 玩家用户id
itemDefId | int | - | - | 道具定义id
type | int | - | - | 道具类型
count | int | - | - | 道具数量
expireTime | int | - | - | 道具过期时间
updateTime | int | - | - | 道具信息更新时间

### 3.3 玩家背包容量表
表名：module_item_volume

字段名	 | 类型 | 默认值 | 索引 | 备注 
--- | --- | --- | --- | ---
userId | int | - | pri | 玩家用户id
gridId | int | - | - | 玩家购买到的最后一个格子id，-1表示一个都还没买

## 4. API
ModuleItem

### 4.1 添加道具到玩家背包
接口名：addItemCount
输入：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | ---
userId | int | - | 玩家用户id
count | int | - | 数量
itemList | 道具列表对象 | - | 道具列表
config | int / array | - | 要添加的道具的配置
itemId | int | null | 道具存储id
exceptions | array | array() | 添加道具的时候排除不向内添加的道具id：[1,2,3,...]
allowExceedLimit | boolean | false | 是否允许道具上限溢出
allowExceed | boolean | false | 是否允许添加背包上限溢出

输出：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | ---
- | 道具列表对象 | - | 操作完成之后的列表对象

说明：

* config：根据给的参数类型不同，有两种情况：
	* int：表明给的参数是itemDefId
	* array：表名给的参数是已经读取出来的itemConfig数组
* itemId：添加道具的目标itemId，e.g 可堆叠的道具A，玩家已经有一条数据了，id是193，然后又获得了道具A，那如果itemId参数给193这个值，添加道具操作就会直接向这条数据(193)内添加，给默认值null表示没有这个需求
* exceptions：这个参数内给的是一个数组，数组的内容是一系列的itemId，只要在里面填了id，则这些id不会被视作道具添加操作的目标
* allowExceed：参考设计部分的说明

### 4.2 扣除玩家背包内道具
接口名：reduceItemCount
输入：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | ---
userId | int | - | 玩家用户id
itemId | int | - | 道具存储id
count | int | - | 数量
itemList | 道具列表对象 | - | 道具列表
config | int / array | - | 要扣除的道具的配置

输入参数细节请参考`接口4.1`

输出：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | ---
- | 道具列表对象 | - | 操作完成之后的列表对象

### 4.3 扣除玩家背包内的某种道具
接口名：reduceItemCountByDefId
输入：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | ---
userId | int | - | 玩家用户id
itemId | int | - | 道具存储id
count | int | - | 数量
itemList | 道具列表对象 | - | 道具列表
config | int / array | null | 要扣除的道具的配置，如果有已经读取完毕的配置，则给出，否则就不用了，因为前面已经有itemDefId这个项了

输入参数细节请参考`接口4.1`

输出：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | ---
- | 道具列表对象 | - | 操作完成之后的列表对象

### 4.4 玩家购买道具
接口名：buyItem
输入：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | ---
userId | int | - | 玩家用户id
count | int | - | 数量
priceId | int | - | 购买使用的货币id
config | int / array | - | 要扣除的道具的配置
itemList | 道具列表对象 | null | 道具列表
useImmediately | boolean | false | 是否立即使用
userLevel | int | 1 | 用户当前等级，用来做一些购买限制条件的检查
friendCount | int | 1 | 用户当前平台好友数量，用来做一些购买限制条件的检查
exceptions | array | array() | 添加道具的时候排除不向内添加的道具id
itemPurchaseRecords | array | null | 玩家购买记录
skipValidation | boolean | false | 跳过检查的项目

输入参数细节请参考`接口4.1`

* 有跳过检查的项目就不进行改项目的检查/验证

输出：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | ---
- | 道具列表对象 | - | 操作完成之后的列表对象
- | int | - | priceId，购买消耗的货币id
- | int | - | priceCount，购买消耗的货币数量
- | array | null | 玩家购买记录，如果玩家购买的道具是限购的，那么这里传出的变量是有数据的，否则就是null

### 4.5 玩家向系统出售道具
接口名：recycleItem
输入：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | ---
userId | int | - | 玩家用户id
count | int | - | 数量
itemList | 道具列表对象 | - | 道具列表
config | int / array | - | 要扣除的道具的配置
sellItemInPackage | boolean | true | 出售的目标道具是否是背包里的道具，出售非背包内的道具的话（地图摆放道具），不扣除数量
itemId | int | null | 道具存储id

输入参数细节请参考`接口4.1`

输出：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | ---
- | 道具列表对象 | - | 操作完成之后的列表对象
- | int | - | recycleId，道具出售获得的货币id
- | int | - | recycleCount，道具出售获得的货币数量

### 4.6 购买背包容量
接口名：purchasePackageVolume
输入：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | ---
userId | int | - | 玩家用户id
targetGridId | int | - | 购买的目标格子id
priceId | int | - | 购买格子用的虚拟货币id（因为购买途径可能多种，这里要给出）
itemList | 道具列表对象 | null | 道具列表，给null表示需要该接口自行去获取

输出：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | ---
- | 道具列表对象 | - | 操作完成之后的列表对象
- | int | - | priceId，消费的虚拟货币id
- | int | - | cost，消费的货币数

说明：

* targetGrid：
	* 加入购买的id和现有的格子id是不连接的，则意味着是一次购买多个格子的操作
	* 格子id从0开始，这是为了计算方便
* 这里要注意，虽然itemList自身的数据没变，但是因为背包容量变了，除了背包容量数据结构之外，itemList里暂存的计算后背包总容量也需要改，否则后续的业务逻辑可能出错

### 4.7 获得道具定价信息
接口名：getItemPriceSetting
输入：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | ---
itemDefId | int | - | 道具定义id
priceId | int | - | 货币虚拟id
itemStoreSetting | array | null | 道具的商城配置信息，可为null

输出：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | ---
- | int | - | priceCount，该道具消费的虚拟货币数