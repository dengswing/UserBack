# 支付模块设计 module_payment
================

维护人 | 版本号 | 描述 | 日期
--- | --- | --- | ---
Jonathan Dai | 0.1 | 初版 | 2013-12-16
Jonathan Dai | 0.2 | 添加配置文件位置描述 | 2013-01-02
fengjie | 0.3 | 更新玩家真钱表字段，增加奖金代币 | 2014-03-31
Jonathan Dai | 0.4 | 更新内容，并添加facebook部分 | 2014-05-16
fengjie | 0.5 | 完成订单接口返回值更新 | 2014-08-12

---

## 1. 设计
**因为支付的订单流转依赖于平台，所以这里的支付模块依赖于社交模块**

### 1.1 概念
主要功能：

* 下订单购买真钱代币
* 完成订单
* 修复订单（交钱没给货，补货）
* 添加/扣除真钱代币的逻辑

### 1.2 设计
因为订单相关的流转逻辑都和平台息息相关，所以这里的设计理念和`社交模块`非常接近，都是使用抽象，并使用factory来管理具体的支付对象（哪个平台的实现）。  

实例对象管理：

* 全程使用`ModulePaymentFactory`来进行平台接口操作对象实例化和获取的管理
* `ModulePaymentFactory::init(ModulePaymentConst::$PFFB)` 来实例化操作对象
* `ModulePaymentFactory::get()` 来获得实例化的操作对象
* 在某些不知道平台名称，但是需要使用payment模块内的几个函数的情况下，可以使用`ModulePaymentFactory::init(ModulePaymentConst::$PFNO)`来初始化一个空实现的操作对象，切记这个对象内的很多API是没有实现的，只返回空

注意项：
 
* 因为真钱数据比较敏感，所以在订单相关流转的逻辑中，都务必保持是一个单API调用，而不要使用组合API通讯。
* 支付模块因为需要使用数据库事务来保证安全，所有要求sql中的所有表，包括了money存储表、平台订单表，都必须放在同一台物理机的同一个db实例的同一张表内。只有这样事务才能真正生效。
* money存储表是不进行分库的，同时也不会进行分表，只会存储在同一张表内。
* 平台订单表也是不分库不分表的，因为这张表内的数据量和用户的操作有关，和用户整体注册量无关，所以DBA务必需要时时查看数据量。

日志相关：

* 因为外部日志系统和游戏本身以及游戏框架没有很大关系，实现也可能因为需求而千变万化，所以这里不涉及记日志这个操作的实现
* 所有有需要记日志的行为，在其接口上都会暴露一个参数，提供给调用者，这个参数是一个php的callable对象，参考[这里](http://php.net/manual/zh/language.types.callable.php)
* 具体来说结构是：

		array(
			$logInstance, // object: log instance
			'logMethodName', // string: log method name
			params, // array: log params provided to log method
		)

游戏内流通货币类型：

* token：代币：通过游戏内的行为可以获得的代币
* money：真钱：分为两部分，为了区分真钱的来源，所以将真钱的概念拆成两块
	* purchasedMoney：由付费充值获得的现金
	* bonusMoney：游戏内通过活动，升级等行为获得的现金

`真钱购买道具时，优先扣除bonus，再扣除money`

## 2. 配置
该模块的配置文件应该放置在app的语言文件夹下：
APP_ROOT/config/**en_us**/module_payment/*.config.php

### 2.1 付费充值配置表
配置文件名：module_payment

配置表结构：Payment

字段名 | 类型 | 默认值 | 使用者 | 索引 | 描述 
--- | --- | --- | --- | --- | ---
paymentDefId | int | - | both | pri | 支付配置id
name | string | - | both | - | 充值名称
type | int | - | both | - | 充值类型
amount | int | - | both | - | 充值数量
packId | int | - | both | - | 礼包id，映射itemDefId
discount | int | - | both | - | 折扣, 10代表10%的折扣，不可用小数点，仅供游戏逻辑中的js进行原价计算，eg：price售价:$100，折扣discount:10%，通过计算原价为:$110
price | int | - | both | - | 售价, 单位为USD或应用自定的货币单位
desc | string | - | both | - | 描述
clientDisplay | int | - | both | - | 是否客户端可见: 1：显示 0：不显示
icon | string | - | both | - | 图片资源

* 充值类型
	* 0：充值金币
	* 1：充值真钱
	* 2：充值礼包

* `amount`与`packId`互斥，仅当type=充值礼包的时候，才可填写packId

## 3. 存储结构
### 3.2 玩家真钱代币表
表名：module_payment

字段名	 | 类型 | 默认值 | 索引 | 备注 
--- | --- | --- | --- | ---
userId | int | - | pri | 玩家id
bonusMoney | int | 0 | - | 游戏获得的真钱代币数，
purchasedMoney | int | 0 | - | 充值获得的真钱代币数

### 3.3 玩家订单表
表名：module_payment_orders

字段名	 | 类型 | 默认值 | 索引 | 备注 
--- | --- | --- | --- | ---
orderId | int | - | pri | 订单号id
userId | int | - | - | 玩家id
platformToken | string | - | uni | 平台支付令牌，根据平台不同，可能由我们提供订单号，这个时候orderId和platformToken是一致的，而有的时候平台也会生成自己的订单凭据，这个时候就存储在这里进行匹配
paymentDefId | int | - | - | 支付配置id
orderTime | int | - | - | 订单创建时间
completeTime | int | - | - | 订单完成时间
status | int | - | - | 订单状态：`0`表示下单未支付；`1`表示下单并支付完成；`2`表示下单支付完成并发货完成
extra | string | - | - | 预留字段，各平台支付细节不同，这里可以储存可变内容

## 4. API
### 4.1 更新玩家代币数量
接口名：updateMoneyAmount
说明：更新玩家真钱代币的数量逻辑
输入：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | --- 
payment | 代币对象 | - | 玩家真钱代币vo对象
amount | int | - | 代币数量变动值，正值表示加，负值表示扣
isBonus | int | true | 是否是奖金变动
logCallback | array | null | 日志回调函数，参见设计部分的注释

输出：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | ---
- | 代币对象 | - | 玩家真钱代币vo对象

### 4.2 下订单
接口名：createOrder
输入：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | --- 
userId | int | - | 玩家id
paymentDefId | int | - | 支付配置id
platformToken | int | null | 平台验证token
extra | array | array() | 订单附加信息

输出：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | ---
- | 订单对象 | - | 创建完成的订单对象

### 4.3 完成订单
接口名：completeOrder
输入：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | --- 

输出：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | ---
userId | int | - | 玩家id
order | 订单对象 | - | 更新后的paymentOrder对象
paymentSetting | 支付配置表 | - | 支付配置表

### 4.4 修复订单
接口名：repairOrder
输入：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | --- 
userId | int | - | 玩家id
orderInfo | string | - | 订单号，根据平台不同，可能是我们库中的orderId，也可能是库中的platformToken

输出：

参数名 | 类型 | 默认值 | 备注
--- | --- | --- | ---
- | 订单对象 | - | 修复的订单对象

## 5. Platform
平台关联的特定内容

### 5.1 Facebook
#### 5.1.1 支付流程
* 玩家在facebook上的游戏页面内点击充值按钮
* 页面js向后端createOrder请求创建一个新的订单
* 页面js获得到订单号(orderId)，附加为request_id参数，调用facebook的FB.ui支付窗口API
* facebook页面弹出充值弹窗
* 玩家确认，并支付
* 支付完成，facebook的FB.ui回调页面js，并向后端发送completeOrder回调
* 后端收到后，验证参数，验证订单信息未完成，则发货并完成，如果订单已完成，则忽略，最后回调js，并通知到前端游戏，更新内容
* 后端也会收到facebook发过来的realtime update，检查传入参数，并获取facebook的订单信息，检查其中的actions，将订单同步为facebook上的状态（标记为完成、争议等），如果是未完成到完成的话，则会发货并完成订单